name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    branches:
      - release

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            frontend/src-tauri/target/
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('frontend/src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-v2-

      - name: Cache MuPDF libraries
        uses: actions/cache@v4
        id: cache-mupdf
        with:
          path: mupdf
          key: mupdf-windows-x64-1.25.6-submodules-v3

      - name: Clone MuPDF with all submodules
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        run: |
          git clone --recurse-submodules --branch 1.25.6 https://github.com/ArtifexSoftware/mupdf.git
          echo "MuPDF cloned with all submodules."

      - name: Build MuPDF core libraries
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd mupdf
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          echo Building libthirdparty...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libthirdparty /verbosity:minimal
          if errorlevel 1 exit /b 1
          echo Building libresources...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libresources /verbosity:minimal
          if errorlevel 1 exit /b 1
          echo Building libmupdf...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libmupdf /verbosity:minimal
          if errorlevel 1 exit /b 1
          echo Core MuPDF libraries built successfully.
          dir platform\win32\x64\Release\*.lib

      - name: Build optional MuPDF libraries
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd mupdf
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          echo Attempting to build libharfbuzz...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libharfbuzz /verbosity:minimal
          if errorlevel 1 echo WARNING: libharfbuzz build failed, will use stub
          echo Attempting to build libzxing...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libzxing /verbosity:minimal
          if errorlevel 1 echo WARNING: libzxing build failed, will use stub
          echo Attempting to build libtesseract...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libtesseract /verbosity:minimal
          if errorlevel 1 echo WARNING: libtesseract build failed, will use stub
          echo Attempting to build libleptonica...
          msbuild platform\win32\mupdf.sln /p:Configuration=Release /p:Platform=x64 /m /t:libleptonica /verbosity:minimal
          if errorlevel 1 echo WARNING: libleptonica build failed, will use stub
          echo Optional library build step complete.

      - name: Verify and stub missing optional libraries
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          set LIBDIR=mupdf\platform\win32\x64\Release
          if not exist "%LIBDIR%" mkdir "%LIBDIR%"
          for %%L in (libharfbuzz.lib libzxing.lib libtesseract.lib libleptonica.lib) do (
            if not exist "%LIBDIR%\%%L" (
              echo Creating valid empty stub for %%L...
              lib.exe /nologo /out:"%LIBDIR%\%%L"
              if errorlevel 1 (
                echo WARNING: lib.exe stub creation failed for %%L
              ) else (
                echo Stub created: %%L
              )
            ) else (
              echo Found existing: %%L
            )
          )
          echo.
          echo Library verification complete:
          dir "%LIBDIR%\*.lib"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build ProTakeoff (Tauri)
        working-directory: frontend
        run: npm run tauri build -- --target x86_64-pc-windows-msvc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SKIP_DEVSERVER_CHECK: "true"

      - name: Find built installer
        id: find-installer
        shell: powershell
        run: |
          $patterns = @(
            "frontend\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\msi\*.msi",
            "frontend\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis\*.exe",
            "frontend\src-tauri\target\release\bundle\msi\*.msi",
            "frontend\src-tauri\target\release\bundle\nsis\*.exe"
          )
          $found = $null
          foreach ($p in $patterns) {
            $files = Get-Item $p -ErrorAction SilentlyContinue
            if ($files) { $found = $files[0].FullName; break }
          }
          if (-not $found) { throw "No installer found after build!" }
          Write-Host "Found: $found"
          echo "installer_path=$found" >> $env:GITHUB_OUTPUT
          echo "installer_name=$(Split-Path $found -Leaf)" >> $env:GITHUB_OUTPUT

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProTakeoff-Windows-Installer
          path: ${{ steps.find-installer.outputs.installer_path }}
          retention-days: 30

      - name: Build summary
        shell: powershell
        run: |
          Write-Host "================================================" -ForegroundColor Green
          Write-Host " BUILD COMPLETE!" -ForegroundColor Green
          Write-Host " Installer: ${{ steps.find-installer.outputs.installer_name }}" -ForegroundColor White
          Write-Host " Download from the Artifacts section below." -ForegroundColor Yellow
          Write-Host "================================================" -ForegroundColor Green
