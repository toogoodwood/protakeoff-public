name: Build Windows Installer

# -------------------------------------------------------
# This workflow builds the ProTakeoff Windows .exe
# To run it: go to Actions tab in GitHub > click
# "Build Windows Installer" > click "Run workflow"
# -------------------------------------------------------

on:
  workflow_dispatch:   # Manual trigger - you click a button in GitHub
  push:
    branches:
      - release        # Also auto-builds if you push to a "release" branch

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest

    steps:
      # ── 1. Get the source code ──────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Node.js for the frontend ──────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ── 3. Set up Rust ───────────────────────────────────
      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # Cache Rust build artifacts (speeds up future builds a lot)
      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            frontend/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('frontend/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # ── 4. Build MuPDF from source (cached) ──────────────
      # MuPDF is the PDF engine the app uses.
      # We cache it so it only takes ~30 min the FIRST time;
      # after that it's instant.
      - name: Cache MuPDF libraries
        uses: actions/cache@v4
        id: cache-mupdf
        with:
          path: mupdf
          key: mupdf-windows-x64-1.25-v3

      - name: Clone MuPDF source
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch 1.25.6 https://github.com/ArtifexSoftware/mupdf.git
          echo "MuPDF cloned successfully"

      - name: Build MuPDF Windows libraries
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd mupdf

          REM Enable Developer Command Prompt tools (MSBuild, cl.exe)
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          REM Build MuPDF and all required static libraries
          msbuild platform\win32\mupdf.sln ^
            /p:Configuration=Release ^
            /p:Platform=x64 ^
            /m ^
            /t:libmupdf ^
            /t:libthirdparty ^
            /t:libresources ^
            /verbosity:minimal
          
          echo "MuPDF build complete. Checking output..."
          dir platform\win32\x64\Release\*.lib

      - name: Build optional MuPDF OCR libraries (tesseract/leptonica)
        if: steps.cache-mupdf.outputs.cache-hit != 'true'
        shell: cmd
        continue-on-error: true   # OCR is optional — app still works without it
        run: |
          cd mupdf
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          REM Build extra OCR libs if present in this MuPDF version
          msbuild platform\win32\mupdf.sln ^
            /p:Configuration=Release ^
            /p:Platform=x64 ^
            /m ^
            /t:libharfbuzz ^
            /verbosity:minimal

          REM Create stubs for any missing optional libs so the linker doesn't fail
          for %%L in (libzxing libtesseract libleptonica libharfbuzz) do (
            if not exist "platform\win32\x64\Release\%%L.lib" (
              echo Creating stub for %%L.lib
              echo. > stub_%%L.c
              cl /c stub_%%L.c /Fostub_%%L.obj
              lib stub_%%L.obj /OUT:"platform\win32\x64\Release\%%L.lib"
            )
          )
          
          echo "OCR library step complete."

      - name: Verify MuPDF libs exist
        shell: powershell
        run: |
          $libDir = "mupdf\platform\win32\x64\Release"
          $required = @("libmupdf.lib", "libthirdparty.lib", "libresources.lib")
          $missing = @()
          foreach ($lib in $required) {
            if (-not (Test-Path "$libDir\$lib")) {
              $missing += $lib
            }
          }
          if ($missing.Count -gt 0) {
            Write-Error "Missing required MuPDF libs: $($missing -join ', ')"
            exit 1
          }

          # Create stubs for optional libs if they don't exist
          $optional = @("libharfbuzz.lib", "libzxing.lib", "libtesseract.lib", "libleptonica.lib")
          foreach ($lib in $optional) {
            if (-not (Test-Path "$libDir\$lib")) {
              Write-Warning "Optional lib $lib not found - creating empty stub"
              # Create minimal valid .lib file (empty archive)
              $bytes = [byte[]]@(0x21, 0x3C, 0x61, 0x72, 0x63, 0x68, 0x3E, 0x0A)
              [IO.File]::WriteAllBytes("$libDir\$lib", $bytes)
            }
          }
          Write-Host "All required MuPDF libraries are present." -ForegroundColor Green

      # ── 5. Install frontend npm packages ─────────────────
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      # ── 6. Build the Tauri app ────────────────────────────
      - name: Build ProTakeoff (Tauri)
        working-directory: frontend
        run: npm run tauri build -- --target x86_64-pc-windows-msvc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Tauri signing: skip for now (unsigned app is fine for personal use)
          TAURI_SKIP_DEVSERVER_CHECK: "true"

      # ── 7. Find and upload the installer ─────────────────
      - name: Find built installer
        id: find-installer
        shell: powershell
        run: |
          $searchPaths = @(
            "frontend\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\msi\*.msi",
            "frontend\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis\*.exe",
            "frontend\src-tauri\target\release\bundle\msi\*.msi",
            "frontend\src-tauri\target\release\bundle\nsis\*.exe"
          )
          $found = $null
          foreach ($pattern in $searchPaths) {
            $files = Get-Item $pattern -ErrorAction SilentlyContinue
            if ($files) { $found = $files[0].FullName; break }
          }
          if ($found) {
            Write-Host "Found installer: $found"
            echo "installer_path=$found" >> $env:GITHUB_OUTPUT
            echo "installer_name=$(Split-Path $found -Leaf)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "No installer found after build!"
            exit 1
          }

      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProTakeoff-Windows-Installer
          path: ${{ steps.find-installer.outputs.installer_path }}
          retention-days: 30

      # ── 8. Also create a GitHub Release ──────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/release'
        with:
          tag_name: v${{ github.run_number }}
          name: ProTakeoff Windows Build ${{ github.run_number }}
          draft: false
          prerelease: false
          files: ${{ steps.find-installer.outputs.installer_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "  BUILD COMPLETE!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "  Installer: ${{ steps.find-installer.outputs.installer_name }}"
          Write-Host ""
          Write-Host "  To download:" -ForegroundColor Yellow
          Write-Host "  1. Click the 'Summary' tab above"
          Write-Host "  2. Scroll to 'Artifacts'"
          Write-Host "  3. Click 'ProTakeoff-Windows-Installer' to download"
          Write-Host ""
